/**
 * JACKALOPE PLANET DEVELOPMENT NOTES
 * 
 * == RECENT BUG FIXES ==
 * 
 * 1. Physics System Error (June 2024)
 *    - Error: TypeError: this.physics.update is not a function
 *    - Fix: Updated Player.js to call physics.apply() instead of physics.update()
 *    - Root Cause: The Player class was calling this.physics.update() but physics components
 *      only implement an apply() method, not update()
 *    - Added error handling and input state passing to physics calls
 * 
 * 2. Camera Reference Error (June 2024)
 *    - Error: Cannot read properties of null (reading 'position')
 *    - Fix: Added defensive checks in updateCameraPosition methods
 *    - Root Cause: Camera references weren't properly inherited from game object
 *    - Added multiple safety checks to prevent null camera errors
 * 
 * 3. Multiplayer Bug (June 2024)
 *    - Issue: Inconsistent isLocal/isActive behavior during player switching
 *    - Fix: Enhanced player initialization and state management logic
 *    - Root Cause: Options/states weren't consistently preserved during player switching
 *    - Added diagnostic overlay (Shift+D) to visualize player states in real-time
 * 
 * == DEVELOPMENT TASKS ==
 */

# Jackalope Planet Development Guide

## ðŸ› ï¸ Recent Bugfixes

### updateCamera Method Error (June 2024)
Fixed critical error: `TypeError: this.updateCamera is not a function` in Player class
- Added updateCameraPosition method to base Player class
- Fixed method call in Player.update() to use correct method name
- Added defensive checks to prevent crashes when camera methods are missing
- Enhanced debug logging for camera position updates
- This was causing jackalope players to crash immediately when spawned

### Camera Reference Error (June 2024)
Fixed critical error: `Cannot read properties of null (reading 'position')` in Player classes
- Added robust defensive checks in updateCameraPosition methods
- Ensured proper camera inheritance from game object in constructors
- Added fallback to game camera when needed
- Fixed BunnyPlayer and HumanPlayer camera update logic to safely handle null references

### Physics System Error (June 2024)
Fixed critical error: `Uncaught TypeError: this.physics.update is not a function` that was causing game crashes
- Added defensive checks in Player.update() to safely handle missing physics components
- Added defensive checks in processInput() to prevent null object access
- Added error handling in Game.animate() to catch and recover from all player update failures
- Created initPhysics() recovery method to rebuild missing physics components
- Added extensive error logging to help diagnose any further issues

### Multiplayer Bug (June 2024)
Fixed critical bug in the multiplayer code where players lost control
- Added comprehensive handling for isLocal/isActive in Player.js 
- Added preservation of options in Game.js
- Enhanced InputManager with diagnostics
- Added diagnostic tools accessible with Shift+D during gameplay
- Updated documentation in MULTIPLAYER.md

## Fixed Multiplayer Bug: Merc Players Not Responding to Input

A critical bug has been fixed in the multiplayer functionality. Merc players spawned with God Mode (2 key) were not receiving input controls because `isLocal` and `isActive` flags were set incorrectly.

**Key changes made:**
1. Added explicit type checking for boolean/string conversion of options
2. Force `isLocal=true` and `isActive=true` for any player with Merc team
3. Enhanced input manager to create proper player options
4. Added diagnostic overlay (toggle with Shift+D)

For details, see the [MULTIPLAYER.md](./src/MULTIPLAYER.md) documentation.

To ensure your changes take effect:
1. Run `npm run build` to rebuild assets
2. The plugin now has automatic cache busting via timestamps in `register_assets()`
3. Use Shift+D during gameplay to diagnose player state issues

## Switching Between Branches

If you switch branches (e.g., from `main` to `modular` or vice versa) and don't see your changes reflected in WordPress, follow these steps:

1. **Edit the plugin file to add cache busting**:
   ```php
   // In jackalope-planet.php, modify the register_assets method:
   public function register_assets() {
       wp_register_style(
           'jackalope-planet-style',
           JACKALOPE_PLANET_PLUGIN_URL . 'dist/style.css',
           [],
           JACKALOPE_PLANET_VERSION . '.' . time()  // Add timestamp for cache busting
       );
       
       wp_register_script(
           'jackalope-planet-script',
           JACKALOPE_PLANET_PLUGIN_URL . 'dist/jackalope-planet.js',
           [],
           JACKALOPE_PLANET_VERSION . '.' . time(),  // Add timestamp for cache busting
           true
       );
   }
   ```

2. **Rebuild assets**:
   ```bash
   npm install  # If switching to a branch with different dependencies
   npm run build
   ```

3. **Clear all WordPress caches**:
   ```bash
   # From project root
   wp @development transient delete-all
   wp @development cache flush
   wp @development acorn optimize:clear
   
   # If @development alias doesn't work, use SSH directly
   ssh bonsai.test "cd /srv/www/bonsai.so/current && wp transient delete-all && wp cache flush && wp acorn optimize:clear"
   ```

4. **Deactivate and reactivate the plugin**:
   ```bash
   # From project root
   wp @development plugin deactivate jackalope-planet
   wp @development plugin activate jackalope-planet
   
   # If @development alias doesn't work, use SSH directly
   ssh bonsai.test "cd /srv/www/bonsai.so/current && wp plugin deactivate jackalope-planet && wp plugin activate jackalope-planet"
   ```

5. **Hard refresh the browser**: 
   - Chrome/Firefox: `Ctrl+Shift+R` or `Cmd+Shift+R` (Mac)
   - Or clear browser cache in developer tools

6. **Verify in browser console**:
   - Open Developer Tools (F12)
   - Check console for your custom log messages
   - Look for: "MODULAR BRANCH: Jackalope Planet initializing" or similar

## Debugging Flamethrower Particles

If the flamethrower particles are not appearing or behaving incorrectly, follow these steps to debug and fix the issue:

1. **Enable Debug Mode**:
   ```javascript
   // In src/js/players/weapons/Flamethrower.js:
   this.debug = true; // Set to true to enable debug logging
   ```

2. **Use the Debug Helper**:
   - Open your browser console (F12)
   - Run the built-in debug helper:
   ```javascript
   window.debugFlamethrower();
   ```
   - This will output diagnostics about the flamethrower state

3. **Check Scene & Particle System**:
   - Verify the flamethrower has a valid scene: Check console for "Scene has valid scene"
   - Confirm particles are being created: Look for "Creating particle system with X particles"
   - Ensure particles are being emitted: Look for "Emitted X particles" logs

4. **Fix Common Particle Issues**:
   - **No scene reference**: Check that `this.scene` is properly assigned in the constructor
   - **Particle system not added**: Ensure `this.scene.add(this.particleSystem)` is called
   - **Shader issues**: Try the alternative implementation by setting `useAlternativeParticles = true`
   - **Visibility problems**: Check that `frustumCulled = false` and particles are not hidden far away

5. **Rebuild and Clear Cache**:
   ```bash
   # Rebuild the assets
   npm run build
   
   # Clear WP cache (run from the site directory)
   wp @development cache flush
   wp @development transient delete-all
   wp @development acorn optimize:clear
   ```

6. **Try the Alternative Implementation**:
   If the standard particle implementation doesn't work, edit `init()` method to use the custom shader version:
   ```javascript
   init(options) {
       // Create weapon model
       this.createWeaponModel();
       
       // Option to try alternative particle system implementation
       const useAlternativeParticles = true; // Set to true for custom shaders
       
       // Create particle system for flames
       if (useAlternativeParticles) {
           console.log('[DEBUG] Using alternative particle system implementation');
           this.createParticleSystem2();
       } else {
           this.createParticleSystem();
       }
       
       // Create debug helpers if enabled
       if (this.debug) {
           this.createDebugHelpers();
       }
   }
   ```

7. **Modify Attribute Names**:
   If particles still aren't showing, try changing the shader attribute names:
   ```javascript
   // Standard THREE.js attribute names
   particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
   particles.setAttribute('color', new THREE.BufferAttribute(colors, 3)); // Not 'particleColor'
   particles.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
   ```

8. **Hard Browser Reset**:
   - Chrome: Open Dev Tools â†’ Network tab â†’ Check "Disable cache"
   - Clear browser cache and cookies
   - Use a private/incognito window for testing

9. **Verify with Debug Sphere**:
   - Check that the red debug sphere appears at the nozzle tip
   - This confirms the weapon model is correctly positioned
   - If it's not visible, there may be issues with the model attachment

10. **Test in Both View Modes**:
    - Test in both first-person and third-person modes (press 'T' to toggle)
    - Different particle behaviors may occur in each mode

## THREE.js Shader Troubleshooting

When working with custom shaders in THREE.js for particle effects, here are some common issues and solutions:

1. **Shader Compilation Errors**:
   - Check console for shader compilation errors
   - WebGL errors typically start with "THREE.WebGLProgram:" or "WebGL: ERROR:"
   - Fix syntax errors in vertex or fragment shaders

2. **Shader Attribute Problems**:
   - Ensure attribute names match between JavaScript and shader code
   - Common issue: JavaScript `setAttribute('color',...)` must match `attribute vec3 color;` in the shader

3. **Uniforms Not Updated**:
   - Ensure uniforms are correctly defined and updated:
   ```javascript
   // In JavaScript
   material.uniforms.time = { value: 0 };
   // In update loop
   material.uniforms.time.value += delta;
   ```

4. **Texture Issues**:
   - Verify textures are loaded correctly and `needsUpdate = true` is set
   - Check texture format compatibility with the device/browser
   - Try a simpler solid-color texture for testing

5. **Point Size Problems**:
   - Some devices have limitations on gl_PointSize
   - Try adjusting the size formula in vertex shader:
   ```glsl
   gl_PointSize = size * (300.0 / -mvPosition.z);
   ```

6. **Simplified Test Shader**:
   If you're having trouble, try this guaranteed-to-render shader:
   ```javascript
   // Vertex shader
   const vertexShader = `
       attribute float size;
       void main() {
           vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
           gl_PointSize = 10.0;
           gl_Position = projectionMatrix * mvPosition;
       }
   `;
   
   // Fragment shader
   const fragmentShader = `
       void main() {
           gl_FragColor = vec4(1.0, 0.5, 0.0, 1.0); // Bright orange
       }
   `;
   ```

7. **Common Alpha Blending Issues**:
   - If particles are visible but don't blend correctly:
   ```javascript
   material.blending = THREE.AdditiveBlending;
   material.transparent = true;
   material.depthWrite = false;
   ```

8. **Compatibility Issues**:
   - Some shader features may not work on all devices
   - Use simpler shader code for wider compatibility
   - Test on multiple browsers/devices

## Particle System Performance Optimization

If your particle system is working but causing performance issues, try these optimizations:

1. **Reduce Particle Count**:
   ```javascript
   this.particleCount = 100; // Start with a lower number and increase as needed
   ```

2. **Optimize Update Cycle**:
   - Only update particles that need updating:
   ```javascript
   // Skip update if far from camera
   const distToCamera = camera.position.distanceTo(this.particleSystem.position);
   if (distToCamera > 100) {
     // Only update every few frames when far away
     if (frameCount % 3 !== 0) return;
   }
   ```

3. **Use GPU Instancing**:
   - For complex particle shapes, use instanced meshes instead of points
   - This can be more efficient for certain types of effects
   ```javascript
   const geometry = new THREE.SphereGeometry(0.1, 4, 4);
   const material = new THREE.MeshBasicMaterial({ color: 0xff5500 });
   const instancedMesh = new THREE.InstancedMesh(geometry, material, this.particleCount);
   ```

4. **Optimize Textures**:
   - Use power-of-two texture sizes (64x64, 128x128)
   - Compress textures where possible
   - Consider using sprite sheets for animated particles

5. **LOD (Level of Detail)**:
   - Implement different detail levels based on distance:
   ```javascript
   if (distToCamera < 10) {
     // High detail - many particles, complex shader
   } else if (distToCamera < 50) {
     // Medium detail - fewer particles
   } else {
     // Low detail - minimal particles or simplified effect
   }
   ```

6. **Batch Similar Particles**:
   - Group similar particles into the same system
   - Minimize material/shader switches

7. **Minimize Attribute Updates**:
   - Only set `needsUpdate = true` for attributes that have changed
   - Consider using typed arrays and direct buffer manipulation

8. **Use Object Pooling**:
   - Reuse particle objects rather than creating new ones
   - This reduces garbage collection pauses

9. **Profile & Measure**:
   - Use Chrome DevTools Performance tab to identify bottlenecks
   - Add a simple FPS counter to measure performance:
   ```javascript
   // Add to your game class
   this.fpsCounter = {
     lastTime: performance.now(),
     frames: 0,
     fps: 0,
     update: function() {
       this.frames++;
       const now = performance.now();
       if (now - this.lastTime > 1000) {
         this.fps = Math.round(this.frames * 1000 / (now - this.lastTime));
         this.frames = 0;
         this.lastTime = now;
         console.log(`FPS: ${this.fps}`);
       }
     }
   };
   ```

## Test System for Major Revisions

To ensure changes are properly implemented with each major revision and testing cycle, follow this structured testing approach:

### 1. Setup Test Version Markers

Add a version marker in your main JS file to verify the correct version is loaded:

```javascript
// In src/js/jackalope-planet.js:
const JACKALOPE_VERSION = 'v1.0.0-modular'; // Update with each major revision
console.log(`Jackalope Planet ${JACKALOPE_VERSION} loaded`);
```

### 2. Automated Test Script

Create a test script in the plugin root:

```bash
#!/bin/bash
# test-plugin.sh - Run before and after each major revision

# 1. Check current branch
BRANCH=$(git branch --show-current)
echo "Testing branch: $BRANCH"

# 2. Build assets
npm run build

# 3. Run lint checks if available
if [ -f "package.json" ] && grep -q "lint" "package.json"; then
  npm run lint
fi

# 4. Clear WP caches
wp @development cache flush
wp @development acorn optimize:clear

# 5. Verify plugin activation
PLUGIN_STATUS=$(wp @development plugin status jackalope-planet --format=json)
echo "Plugin status: $PLUGIN_STATUS"

# 6. Perform visual regression test if available
if [ -f "visual-test.js" ]; then
  node visual-test.js
fi

echo "Test complete. Remember to verify in browser!"
```

Make it executable:
```bash
chmod +x test-plugin.sh
```

### 3. Visual Feature Checklist

Create a feature verification document to check before/after each revision:

```md
# Jackalope Planet Feature Checklist

## Core Features
- [ ] 3D planet renders properly
- [ ] Controls work (WASD movement)
- [ ] Mode switching works (first/third person)
- [ ] Performance is acceptable (no frame drops)

## New Features (modular branch)
- [ ] Player physics system working
- [ ] Weapon system functional
- [ ] UI elements display correctly

## Regression Tests
- [ ] Check mobile compatibility
- [ ] Test all shortcode parameters
- [ ] Verify compatibility with theme
```

### 4. Browser Console Test Helper

Add a test helper function to verify features via console:

```javascript
// In src/js/jackalope-planet.js:
// Test helper - accessible via browser console
window.testJackalope = {
  version: JACKALOPE_VERSION,
  runTests: function() {
    console.group('Jackalope Planet Tests');
    console.log('Testing version:', this.version);
    
    // Test game instances
    const games = document.querySelectorAll('.jackalope-planet-canvas-container');
    console.log('Game instances found:', games.length);
    
    // Test current mode
    const mode = window.currentMode || 'unknown';
    console.log('Current mode:', mode);
    
    // Test game features based on branch
    if (this.version.includes('modular')) {
      console.log('Testing modular branch features...');
      // Add specific modular branch tests
    }
    
    console.groupEnd();
    return 'Tests complete';
  }
};

console.log('Jackalope Planet test helper available. Run window.testJackalope.runTests() to verify.');
```

## Common Issues

- **Plugin shows old code**: Make sure you've rebuilt assets after switching branches
- **CSS not updating**: Add a distinctive visual change to verify updates
- **JS not running correctly**: Check browser console for errors
- **Persistent caching**: Use time() in the version string as shown above

## Development Tips

- Add unique console.log messages to verify you're using the correct branch
- Modify the plugin name temporarily to confirm WordPress is loading your version
- Make simple visual changes to test updates are working 

## Recent Updates and Bug Fixes

### Player Control Fix (July 13, 2023)

- **Bug fixed**: Players not responding to keyboard controls, unable to move characters.
- **Root cause**: Initial player was created with `isLocal: false` which prevented it from receiving keyboard input.
- **Fix implemented**:
  - Modified `Game.createNewPlayer()` to force `isLocal=true` for the first player
  - Added additional forced setting of both `isLocal` and `isActive` flags for the initial player
  - Enhanced logging to clearly show when player flags are overridden
  - Added defensive check to ensure first player always gets input

### Input System Error Fix (July 12, 2023)

- **Bug fixed**: `TypeError: s.getInputState is not a function` error that was preventing player movement and causing game crashes.
- **Root cause**: The `InputManager` class was missing the `getInputState()` method that physics components were trying to call.
- **Fix implemented**:
  - Added the `getInputState()` method to `InputManager.js` to provide a standardized input format for physics components.
  - Fixed Player constructor to properly handle and preserve `isLocal` flag, ensuring it can't be accidentally overwritten.
  - Updated `BunnyPlayer` and `HumanPlayer` constructors to match the updated Player constructor signature.
  - Added defensive checks to maintain `isLocal=true` for local players.

### Local Player Flag Preservation (July 12, 2023)

- **Bug fixed**: Player `isLocal` flag was sometimes being lost, preventing input controls from working properly.
- **Fix implemented**:
  - Added forceful Boolean conversion in Player constructor for `isLocal` and `isActive` flags.
  - Ensured `isLocal` flag is preserved during network state updates.
  - Added defensive double-set of `isLocal=true` in player subclasses after super() constructor.

### Camera Reference Error (July 11, 2023)

- **Bug fixed**: Camera references were sometimes undefined, causing null pointer errors.
- **Root cause**: Scene and camera weren't properly passed between classes.
- **Fix implemented**:
  - Added defensive checks in `updateCameraPosition` methods
  - Ensured players properly inherit camera from game object in constructors

### Physics System Error (July 11, 2023)

- **Bug fixed**: "Physics missing or invalid for player" error and "this.physics.update is not a function"
- **Root cause**: The physics system was being initialized incorrectly or the wrong method was being called.
- **Fix implemented**:
  - Added defensive checks to verify physics exists before using it
  - Changed Player update method to call `this.physics.apply()` instead of `this.physics.update()`
  - Added error handling and recovery for physics initialization

### Multiplayer Bug (July 10, 2023)

- **Bug fixed**: Spawned Merc players not responding to input controls.
- **Root cause**: Complex issue with isLocal/isActive flags and InputManager integration.
- **Fix implemented**:
  - Comprehensive handling for isLocal/isActive in Player.js
  - Enhanced InputManager with diagnostics
  - Improved player switching logic in Game.js

### How to make sure changes take effect

1. After making code changes, remember to:
   - Run `npm run build` to rebuild the plugin assets
   - The plugin automatically busts cache with a timestamp in asset URLs
   - SSH into the VM and toggle the plugin: `wp plugin deactivate jackalope-planet && wp plugin activate jackalope-planet`
   - Use Shift+D during gameplay to see diagnostic overlays with player state information 

# Jackalope Planet Plugin Development Rules

## Recent Bug Fixes

### Player Rotation Fix (July 25, 2023)
- Fixed critical error: `Cannot read properties of undefined (reading 'lerp')` in BaseMovement.rotate
- Added player.direction vector in Player constructor to prevent null reference
- Enhanced rotate method with comprehensive defensive checks
- Implemented alternative vector update approach when lerp is unavailable
- Added try/catch logic to prevent rotation errors from crashing the game

### Input System Fixes (July 24, 2023)
- Fixed issues with keyboard input not being processed correctly for player movement
- Enhanced BunnyControls.getInput() to provide more complete input data to movement system
- Added explicit BunnyPlayer.processInput() method that directly coordinates with BunnyMovement
- Improved BunnyMovement.update() to handle different types of input formats
- Added emergency fallback movement when components are missing
- Added detailed debugging to track input processing through the entire chain

### Camera Reference Fix (July 23, 2023)
- Fixed critical camera reference error in BunnyPlayer and HumanPlayer classes
- Added defensive checks in updateCameraPosition methods to prevent null reference errors
- Ensured proper camera inheritance from game object in constructors
- Added fallbacks when camera objects are missing
- Improved camera position update logic for smoother following

### Physics System Fixes (July 22, 2023)
- Fixed critical error with physics system using undefined method
- Added defensive checks for this.physics.update vs this.physics.apply
- Fixed player position updates when physics is undefined
- Added safety checks for scene references throughout physics code

### Multiplayer Bug Fixes (July 21, 2023)
- Resolved critical bug where first player was created with isLocal=false
- Fixed issues with toggling between player modes
- Added enhanced input handling when switching between players
- Improved diagnostics system (press Shift+D) to view player states and fix issues

## Testing Instructions

### General
- Use WASD keys to move
- Press T to toggle between modes
- Press G to enable God Mode
- In God Mode, press 1 to spawn a Jackalope, 2 to spawn a Merc
- Press Shift+D to open diagnostic overlay

### Input Testing
- Ensure WASD keys control player movement correctly
- Verify input propagates from keyboard through InputManager, to Player, to Movement system
- Confirm movement works in both third-person and first-person modes
- Test that movement is relative to camera angle

### Camera Testing
- Check that camera follows player smoothly
- Verify camera rotation works with mouse movement
- Test camera collision detection with terrain
- Confirm switching between first and third person cameras

## Known Issues and Workarounds

### Camera Delay Issue
- Symptom: Camera sometimes lags behind player movement
- Workaround: Use smoother camera interpolation via updateCameraPosition method
- Fix: Enhance camera update logic with proper timing and defensive checks
- Status: Partially fixed, investigation ongoing

### Material Warnings
- Warnings about MeshBasicMaterial properties (emissive, emissiveIntensity, receiveShadow)
- These are non-critical and do not affect gameplay
- Fix planned in future update to use correct material types

## Current Development Priorities
1. Finish and refine multiplayer functionality
2. Add terrain collision detection
3. Implement additional weapons
4. Create level loading system

## Best Practices
- Always use defensive coding with null checks
- Add detailed logging for critical paths
- Maintain input system chain: InputManager -> Player.processInput -> Movement.update
- Ensure camera references are properly handled
- Verify all vectors are properly initialized before math operations

## Project Structure
- core/ - Game engine components
- players/ - Player classes and components
- environment/ - World building and terrain
- ui/ - User interface elements
- networking/ - Multiplayer functionality
- weapons/ - Weapon systems and effects 